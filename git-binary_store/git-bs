#!/bin/bash -x
# Copyright (C) <2017>  <Ding Wei>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Change log
# 170606 Create by Ding Wei
source /etc/bash.bashrc
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH
export LC_CTYPE=C
export LC_ALL=C

export BS_VER=0.0.1
export BS_OPTION=$1
export BS_TARGET=$(echo $* | sed "s/$BS_OPTION //g")

BS_help()
{
 echo "
git-bs/$BS_VER ()
git bs <command> [<args>]

Git BS is a system for managing and versioning binary files in
association with a Git repository.  Instead of storing the binary files
within the Git repository as blobs, Git BS stores special 'pointer
files' in the repository, while storing the actual file contents on a
Git BS server.  The contents of the binary file are downloaded
automatically when needed, for example when a Git branch containing
the binary file is checked out.

Commands
--------

* git bs env:
    Display the Git BS environment.
* git bs checkout:
    Populate working copy with real content from Git BS files
* git bs clone:
    Efficiently clone a Git BS-enabled repository
* git bs fetch:
    Download git BS files from a remote
* git bs fsck:
    Check GIT BS files for consistency.
* git bs install:
    Install Git BS configuration.
* git bs logs:
    Show errors from the git-bs command.
* git bs ls-files:
    Show information about Git BS files in the index and working tree.
* git bs pull:
    Fetch BS changes from the remote & checkout any required working tree files
* git bs push:
    Push queued binary files to the Git BS endpoint.
* git bs status:
    Show the status of Git BS files in the working tree.
* git bs track:
    View or add Git BS paths to Git attributes.
* git bs untrack:
    Remove Git BS paths from Git Attributes.
* git bs update:
    Update Git hooks for the current Git repository.
* git bs version:
    Report the version number.
"
}

BS_version()
{
 echo git-bs/$BS_VER
}

BS_env()
{
 BS_version
 $(git version)
 echo "
git config git-bs.url = '$(git config --global git-bs.url)'
git config git-bs.username = '$(git config --global git-bs.username)'
git config git-bs.password = '$(git config --global git-bs.password)'
git config git-bs.filter.clean = '$(git config --global filter.git-bs.clean)'
git config git-bs.filter.smudge = '$(git config --global filter.git-bs.smudge)'
git config git-bs.filter.process = '$(git config --global filter.git-bs.process)'
git config git-bs.filter.required = '$(git config --global filter.git-bs.required)'
"
}

BS_CHECK_ENV()
{
 if [[ -z $GIT_TOP || ! -d $GIT_TOP/.git ]] ; then
     EXIT 1 "You need to run this command from the toplevel of the working tree."
 fi

 if [[ ! $(git config --global git-bs.url) ]] ; then
     EXIT 1 "You need define git-bs.url by 'git config --global git-bs.url LOCAL_BS_SERVER_URL'."
 else
     export BS_SERVER=$(git config --global git-bs.url)
 fi

 if [[ ! $(git config --global git-bs.username) ]] ; then
     EXIT 1 "You need define git-bs.url by 'git config --global git-bs.username LOCAL_BS_SERVER_USERNAME'."
 else
     export BS_SERVER_USERNAME=$(git config --global git-bs.username)
 fi

 if [[ ! $(git config --global git-bs.password) ]] ; then
     EXIT 1 "You need define git-bs.password by 'git config --global git-bs.password LOCAL_BS_SERVER_PASSWORD'."
 else
     export BS_SERVER_PASSWORD=$(git config --global git-bs.password)
 fi

 if [[ -z $(git config --global filter.git-bs.required) ]] ; then
     git config --global filter.git-bs.clean "git-bs clean %f"
     git config --global filter.git-bs.smudge "git-bs smudge %f"
     git config --global filter.git-bs.process "git-bs filter-process"
     git config --global filter.git-bs.required true
 fi

 if [[ ! $(which vbindiff) || ! $(which svn) || ! $(which rsync) ]] ; then
     EXIT 1 "Please setup vbindiff, subversion and rsync"
 fi
 if [[ ! -d $GIT_TOP/.git/git-bs ]] ; then
     BS_clone
 fi
}

SPLIT_LINE()
{
 echo '========================================'
 echo "$1"
 echo '========================================'
}

EXIT()
{
 popd >/dev/null 2>&1
 SPLIT_LINE "$2"
 exit $1
}

BS_clone()
{
 if [[ -d $GIT_TOP/.git/git-bs ]] ; then
    SPLIT_LINE ":Local git-binary_store clone ready"
 else
    svn co -q $BS_SERVER_OPTION $BS_SERVER $GIT_TOP/.git/git-bs
 fi
}

BS_update()
{
 if [[ -d $GIT_TOP/.git/git-bs ]] ; then
    svn up -q $BS_SERVER_OPTION $GIT_TOP/.git/git-bs
 else
    SPLIT_LINE "Cannot find local git-binary_store, please clone it!"
 fi
}

BS_checkout()
{
 echo $1
}

BS_pull()
{
 BS_clone
 BS_checkout
}

BS_push()
{
 echo $1
}

BS_status()
{
 echo $1
}

BS_track()
{
 export BS_track_INPUT=$1
 for BS_track_TARGET in $(ls $BS_track_INPUT)
 do
    export BS_track_URL=$(dirname $BS_track_TARGET)
    export BS_track_OBJ=$(basename $BS_track_TARGET)

    if [[ ! $(grep "^$BS_track_TARGET filter=git-bs" .gitattributes) ]] ; then
        echo "$BS_track_TARGET filter=git-bs diff=git-bs merge=git-bs -text" >>.gitattributes
    else
        SPLIT_LINE "$BS_track_TARGET in track list already"
    fi
 done
 git add .gitattributes
 SPLIT_LINE "Current .gitattributes"
 cat .gitattributes
}

BS_untrack()
{
 export BS_track_INPUT=$1
 for BS_track_TARGET in $(ls $BS_track_INPUT)
 do
    export BS_track_URL=$(dirname $BS_track_TARGET)
    export BS_track_OBJ=$(basename $BS_track_TARGET)

    if [[ $(grep "^$BS_track_TARGET filter=git-bs" .gitattributes) ]] ; then
        grep -v "^$BS_track_TARGET filter=git-bs" .gitattributes >.git/.gitattributes.tmp
        cp .git/.gitattributes.tmp .gitattributes
    else
        SPLIT_LINE "$BS_track_TARGET NOT in track list"
    fi
 done
 git add .gitattributes
 SPLIT_LINE "Current .gitattributes"
 cat .gitattributes
}

BS_clean()
{
 rm -fr $GIT_TOP/.git/git-bs
 EXIT 0 "Please clone before use local git-binary_store"
}

BS_smudge()
{
 pushd $GIT_TOP >/dev/null 2>&1
 export BS_smudge_INPUT=$1
 for BS_smudge_TARGET in $(ls $BS_smudge_INPUT)
 do
    export BS_smudge_URL=$(dirname $BS_smudge_TARGET)
    export BS_smudge_OBJ=$(basename $BS_smudge_TARGET)

    cat .gitattributes | while read BS_track_ENTRY
    do
       export BS_track_SOURCE=$(echo $BS_track_ENTRY | awk -F' ' {'print $1'})
       if [[ ! -f $BS_track_SOURCE ]] ; then
           EXIT 1 "Cannot find $BS_track_SOURCE"
       fi
       for BS_track_MD5 in $(ls $BS_track_SOURCE | md5sum | awk -F' ' {'print $1'})
       do
           export BS_METADATA_NAME=$BS_track_MD5
           mkdir -p $GIT_TOP/.git/git-bs/metadata
           cp $BS_track_SOURCE $GIT_TOP/.git/git-bs/metadata/$BS_METADATA_NAME
           svn add -q $GIT_TOP/.git/git-bs/metadata/$BS_METADATA_NAME
      done
    done
done
}

BS_process()
{
 echo $1
}

export GIT_TOP=$(git rev-parse --show-toplevel)
BS_CHECK_ENV
export BS_SERVER_OPTION="--non-interactive --no-auth-cache --username $BS_SERVER_USERNAME --password $BS_SERVER_PASSWORD"

pushd $GIT_TOP >/dev/null 2>&1

if [[ $BS_OPTION = pull ]] ; then
    BS_pull
elif [[ $BS_OPTION = push ]] ; then
    BS_push
elif [[ $BS_OPTION = status ]] ; then
    BS_status
elif [[ $BS_OPTION = track ]] ; then
    BS_track "$BS_TARGET"
elif [[ $BS_OPTION = untrack ]] ; then
    BS_untrack "$BS_TARGET"
elif [[ $BS_OPTION = update ]] ; then
    BS_update
elif [[ $BS_OPTION = version ]] ; then
    BS_version
elif [[ $BS_OPTION = env ]] ; then
    BS_env
elif [[ $BS_OPTION = chekout ]] ; then
    BS_checkout
elif [[ $BS_OPTION = clone ]] ; then
    BS_clone
elif [[ $BS_OPTION = clean ]] ; then
    BS_clean
elif [[ $BS_OPTION = smudge ]] ; then
    BS_smudge "$BS_TARGET"
elif [[ $BS_OPTION = "filter-process" ]] ; then
    BS_process
else
    BS_help
fi

